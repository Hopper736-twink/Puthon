<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Python IDE Lite + Secure AI</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
        :root { --bg: #1e1e1e; --header: #2d2d2d; --accent: #007acc; --text: #d4d4d4; --console-bg: #000; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; overflow: hidden; }
        
        .toolbar { height: 40px; background: var(--header); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #3c3c3c; }
        .status { font-size: 11px; color: #888; letter-spacing: 0.5px; cursor: pointer; }
        .run-btn { background: #388e3c; color: white; border: none; padding: 4px 12px; border-radius: 3px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .run-btn:hover { background: #45a049; }

        #editor-container { height: calc(65% - 40px); border-bottom: 2px solid #333; }
        #editor { width: 100%; height: 100%; background: var(--bg); color: #9cdcfe; border: none; padding: 15px; font-size: 15px; outline: none; resize: none; box-sizing: border-box; line-height: 1.5; }

        #console { height: 35%; background: var(--console-bg); color: #4af626; padding: 12px; font-size: 13px; overflow-y: auto; white-space: pre-wrap; box-sizing: border-box; font-family: 'Courier New', monospace; }
        .err { color: #f44747; }

        #ai-modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 500px; background: #252526; border: 1px solid var(--accent); 
            border-radius: 6px; padding: 20px; z-index: 10000; box-shadow: 0 20px 50px rgba(0,0,0,0.7); 
        }
        #ai-prompt { width: 100%; background: #3c3c3c; border: 1px solid #555; color: #fff; padding: 12px; border-radius: 4px; outline: none; box-sizing: border-box; font-size: 14px; margin-top: 10px; resize: none; }
        .ai-submit { background: var(--accent); color: white; border: none; padding: 12px; width: 100%; margin-top: 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        
        #secret-zone { position: fixed; top: 0; left: 0; width: 40px; height: 40px; z-index: 9999; }
    </style>
</head>
<body>

<div id="secret-zone"></div>

<div class="toolbar">
    <div class="status" id="status" onclick="resetKey()" title="Нажми, чтобы сбросить API ключ">● PYTHON 3.10 READY</div>
    <button class="run-btn" onclick="runCode()">RUN (Ctrl+Enter)</button>
</div>

<div id="editor-container">
    <textarea id="editor" spellcheck="false" placeholder="Пиши код здесь..."># Пример кода
print("Hello World!")</textarea>
</div>

<div id="console">Загрузка Python...</div>

<div id="ai-modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="color:var(--accent); font-size:14px; font-weight:bold;">AI ASSISTANT (Safe Mode)</span>
        <span onclick="closeAI()" style="cursor:pointer; color:#888;">✕</span>
    </div>
    <textarea id="ai-prompt" rows="4" placeholder="Что сделать? (н-р: 'напиши калькулятор' или 'исправь ошибки')"></textarea>
    <button class="ai-submit" onclick="askAI()">ПРИМЕНИТЬ ПРАВКИ</button>
</div>

<script>
    let pyodide;
    let secretCounter = 0;

    async function init() {
        pyodide = await loadPyodide();
        document.getElementById('status').innerText = "● PYTHON 3.10 READY (Клик для сброса ключа)";
        document.getElementById('console').innerText = "Консоль готова. Нажми Ctrl+Q для ИИ помощника.";
    }
    init();

    // Сброс ключа
    function resetKey() {
        if(confirm("Сбросить сохраненный API ключ?")) {
            localStorage.removeItem('openrouter_api_key');
            alert("Ключ удален. При следующем запросе ИИ спросит новый.");
        }
    }

    async function runCode() {
        const code = document.getElementById('editor').value;
        const out = document.getElementById('console');
        out.innerText = "Выполнение...";
        
        try {
            await pyodide.runPythonAsync(`
                import sys
                import io
                from js import window
                sys.stdout = io.StringIO()
                def custom_input(prompt=""):
                    return window.prompt(prompt)
                __builtins__.input = custom_input
            `);
            
            await pyodide.runPythonAsync(code);
            const stdout = pyodide.runPython("sys.stdout.getvalue()");
            out.innerText = stdout || "[Программа завершена без вывода]";
        } catch (err) {
            out.innerHTML = `<span class="err">Ошибка:\n${err}</span>`;
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && (e.key === 'q' || e.key === 'й')) { e.preventDefault(); toggleAI(); }
        if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); runCode(); }
    });

    function toggleAI() {
        const modal = document.getElementById('ai-modal');
        modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        if (modal.style.display === 'block') document.getElementById('ai-prompt').focus();
    }

    function closeAI() { document.getElementById('ai-modal').style.display = 'none'; }

    async function askAI() {
        const promptText = document.getElementById('ai-prompt').value;
        const currentCode = document.getElementById('editor').value;
        const out = document.getElementById('console');

        // --- БЕЗОПАСНОЕ ПОЛУЧЕНИЕ КЛЮЧА ---
        let apiKey = localStorage.getItem('openrouter_api_key');
        
        if (!apiKey) {
            apiKey = window.prompt("Введите ваш OpenRouter API Key.\nОн сохранится в вашем браузере и не попадет на GitHub.");
            if (!apiKey) return;
            localStorage.setItem('openrouter_api_key', apiKey);
        }

        closeAI();
        out.innerText = "ИИ думает...";

        try {
            const response = await fetch("[https://openrouter.ai/api/v1/chat/completions](https://openrouter.ai/api/v1/chat/completions)", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${apiKey}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "model": "google/gemini-2.0-flash-exp:free",
                    "messages": [
                        {"role": "system", "content": "Ты - Python эксперт. Верни ТОЛЬКО чистый код. Не используй разметку ```python, только текст кода."},
                        {"role": "user", "content": `Код:\n${currentCode}\n\nЗадача: ${promptText}`}
                    ]
                })
            });

            const data = await response.json();
            
            if (data.error) {
                if (data.error.code === 401) {
                    alert("Неверный API ключ. Сбрасываю...");
                    localStorage.removeItem('openrouter_api_key');
                }
                throw new Error(data.error.message);
            }

            let newCode = data.choices[0].message.content;
            // Очистка от возможных Markdown-кавычек
            newCode = newCode.replace(/```python/g, "").replace(/```/g, "").trim();
            
            document.getElementById('editor').value = newCode;
            out.innerText = "ИИ: Исправления внесены!";
        } catch (e) {
            out.innerText = "Ошибка ИИ: " + e.message;
        }
    }
</script>
</body>
</html>
